<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.metersphere.functional.mapper.ExtCaseReviewFunctionalCaseMapper">

    <select id="list" resultType="io.metersphere.functional.dto.FunctionalCaseReviewDTO">
        SELECT
            cr.num as reviewNum, cr.name as reviewName, cr.status as reviewStatus, cf.status, cf.update_time
        FROM
        case_review_functional_case cf left join case_review cr on  cf.review_id = cr.id
        where cf.case_id = #{request.caseId}
        <if test="request.keyword != null and request.keyword != ''">
            and (
            cr.num like concat('%', #{request.keyword},'%')
            or cr.name like concat('%', #{request.keyword},'%')
            )
        </if>
    </select>

    <select id="getUnCompletedCaseCount" resultType="java.lang.Long">
        SELECT
            count(1)
        FROM
        case_review_functional_case
        where review_id = #{reviewId}
        and status in
        <foreach collection="statusList" item="status" open="(" separator="," close=")">
            #{status}
        </foreach>
    </select>

    <update id="updateStatus">
        update case_review_functional_case
        set status = #{status},
        update_time = UNIX_TIMESTAMP()*1000
        where review_id = #{reviewId} and case_id = #{caseId}
    </update>

</mapper>